{% extends "base.html" %}
{% load staticfiles %}
{% load site_utils %}

{% block title %}
{{campaign.title}}
{% endblock %}

{% block head %}

<style>
label {
  margin-top: .25em;
  font-weight: normal;
  font-size: 90%;
}

#amount-wrapper {
  max-width: 13em;
  border: 1px solid #AAA;
  margin-right: 1em;
}
  #amount-wrapper .input-group-addon, #amount-wrapper input {
    border: none;
    font-size: 24px;
    text-align: right;
  }


#legalspeak {
  margin: 1.5em 0 2.5em 0;
  font-size: 90%;
}

#line-items th {
  font-weight: normal;
}
#line-items tr.recipient-disabled {
  text-decoration: line-through;
  color: #AAA;
}
#line-items tr .glyphicon {
  color: #999;
  cursor: pointer;
  -webkit-transition: -webkit-transform 1s linear 0;
  -moz-transition: -moz-transform 1s linear 0;
  transition: all .75s;
}
  #line-items tr.recipient-disabled .glyphicon-remove {
    transform: rotate(45deg) scale(.9);
    color: #F88;
  }
</style>
{% endblock %}

{% block body %}
  <h1>{{campaign.headline}}</h1>

  <div id="subhead">{{campaign.subhead}}</div>

  <div id="intro">
    {{campaign.body|markdown}}
  </div>

  <form id="contribution-form" onsubmit="return false;" autocomplete="on">
    <input type="hidden" name="rstate" value="{{rstate}}"/>
    <input type="hidden" name="ref_code" value="{{request.GET.utm_campaign}}"/>

    <label for="amount">Amount</label>

    <table style="margin-bottom: 1em">
    <tr><td>
      <div id="amount-wrapper" class="input-group">
        <div class="input-group-addon">$</div>
        <input id="amount" name="amount" class="form-control" type="text" value="{{suggested_amount|currency|cut:"$"}}" pattern="^([0-9]+(,[0-9]{3})*)?(\.[0-9]{0,2})?$" title="Contribution Amount" onkeyup="amount_validation()" onchange="amount_validation()">
      </div>
    </td><td>
      ({{max_contrib|currency}} max)
    </td></tr></table>

    <div id="contributor">
          <div id="contributor-email" class="form-group">
            <label for="email">Email Address</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="yourname@youremail.com" required>
          </div> <!-- contributor-email -->

          <label>Name and Address</label>
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group">
                {# <label for="nameFirst">First Name</label> #}
                <input type="text" class="form-control" id="nameFirst" name="nameFirst" placeholder="first name" required>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                {# <label for="nameLast">Last Name</label> #}
                <input type="text" class="form-control" id="nameLast" name="nameLast" placeholder="last name" required>
              </div>
            </div>
          </div>
          <div class="form-group">
            {# <label for="address">Address</label> #}
            <input type="text" class="form-control" id="address" name="address" placeholder="123 Your Location St." required>
          </div>
          <div class="row">
            <div class="col-sm-5 col-md-6">
              <div class="form-group">
                {# <label for="city">City</label> #}
                <input type="text" class="form-control" id="city" name="city" placeholder="Everytown" required>
              </div>
            </div>
            <div class="col-sm-3 col-md-2">
              <div class="form-group">
                {# <label for="state">State</label> #}
                <input type="text" class="form-control" id="state" name="state" placeholder="state" required>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="form-group">
                {# <label for="zip">ZIP</label> #}
                <input type="text" class="form-control" id="zip" name="zip" placeholder="zip code" maxlength="10" required>
              </div>
            </div>
          </div> <!-- /row -->
          <div class="row">
            <div class="col-sm-6 notEmployedTarget">
              <div class="form-group">
                <label for="occupation">Occupation</label>
                <input type="text" class="form-control" id="occupation" name="occupation">
              </div>
            </div>
            <div class="col-sm-6 notEmployedTarget">
              <div class="form-group">
                <label for="employer">Employer</label>
                <input type="text" class="form-control" id="employer" name="employer">
              </div>
            </div>
          </div>
          <label for="notEmployed" style="margin: 0 0 1em 0">
            <input id="notEmployed" type="checkbox" onchange="$('.notEmployedTarget').fadeToggle(!$(this).prop('checked')); if ($(this).prop('checked')) { $('#occupation').val('not employed'); $('#employer').val('none'); }">
            Retired or not employed?
          </label>

    </div> <!-- /pledge-contributor -->

      <div id="pledge-payment">
            <div class="row" style="max-width: 20em">
              <div class="col-sm-12 form-group">
                <label for="ccNum">Credit Card Number</label>
                <input type="text" class="form-control" id="ccNum" name="ccNum" autocomplete="cc-number" placeholder="0000 0000 0000 0000" required>
              </div>
              <div class="col-sm-6 form-group">
                <label for="ccExp">Expiration</label></td>
                <input type="text" class="form-control" id="ccExp" name="ccExp" placeholder="MM/YYYY" required>
              </div>
              <div class="col-sm-6 form-group">
                <label for="ccCVV">CVV</label>
                <input type="text" class="form-control" id="ccCVV" name="ccCVV" required autocomplete="off">
              </div>
            </div>
      </div> <!-- /pledge-payment -->

      <div id="legalspeak">
        <p>You must:</p>
        <ul>
        <li>Be either a U.S. citizen or lawfully admitted permanent resident (i.e., a green card holder).</li>
        <li>Not be employed directly by the federal government as a contractor.</li>
        <li>Make this contribution with your own funds, which were not provided to you by any other person or entity. You must use your own personal credit card, and not a corporate or business card or a card issued to another person.</li>
        </ul>
        <p>By clicking next, you agree that you have reviewed the contributor requirements above and our <a href="https://if.then.fund/terms" target="_blank">terms of use</a>.</p>
      </div>

      <button class="btn btn-primary" onclick="do_submit();" style="display: block; margin: 1em 0; width: 100%; font-size: 18px; font-weight: bold; text-transform: uppercase;">Contribute</button>

      <div style="text-align: center;">
        <button class="btn btn-default" onclick="show_contribution_details_modal();">See How Your Contribution Will Be Divided</button>
      </div>
  </form>

  <div id="contribution_details_modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="contribution_details_modal_title" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="contribution_details_modal_title">
            Contribution Details
          </h4>
        </div>
        <div class="modal-body">
          <p>Your contribution will be divided among the candidates below. {{campaign.owner.name}} has pre-set weights to direct more contributions to the candidates that need it most.</p>
          <p>The amounts below are before credit card and processing fees. You can omit a candidate from your contributions by clicking the <span class="glyphicon glyphicon-remove" alt="ex"> </span>.</p>

          <table id="line-items" class="table" style="margin-top: 1em; width: auto;">
            <thead>
              <tr><th>Recipient</th> <th>Amount</th> <th></th></tr>
            </thead>
            <tbody>
              {% for recip in recipients %}
                <tr data-recipient-id="{{recip.id}}">
                  <td>{{recip.name}}</td>
                  <td class="amount">...</td>
                  <td onclick="toggle_recipient(this);">
                    <span class="glyphicon glyphicon-remove" title="Turn this recipient on/off."> </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static "vendor/jquery.payment.js" %}"> </script>
  <script src="{% static "vendor/mailcheck.min.js" %}"> </script>

  <script>
  $(function() {
    // Initialize field validation.
    $('#ccNum').payment('formatCardNumber');
    $('#ccExp').payment('formatCardExpiry');
    $('#ccCVV').payment('formatCardCVC');

    var _popover_state = { };
    $('#email').on('blur', function() {
      console.log(0)
      function email_popover(text) {
        var e = $('#email');
        if (_popover_state.state) e.popover("destroy");
        if (text) {
          e.popover({ content: text, placement: 'bottom' }).popover('show');
          _popover_state.state = true;
        } else {
          _popover_state.state = false;
        }
      }
      $('#email').mailcheck({
        suggested: function(element, suggestion) {
          // warning
          email_popover("Are you sure you didn't mean " + suggestion.full + "?");
        },
        empty: function(element) {
          // no warning
          email_popover(); // clear
        }
      });
    });

    // Demo values.
    if (window.location.hash == "#demo") {
      $('#email').val("demo+" + parseInt(1000+Math.random()*5000) + "@{{SITE_DOMAIN}}")
      $('#nameFirst').val('{{random_user_info.nameFirst|escapejs}}')
      $('#nameLast').val('{{random_user_info.nameLast|escapejs}}')
      $('#address').val('{{random_user_info.address|escapejs}}')
      $('#city').val('{{random_user_info.city|escapejs}}')
      $('#state').val('{{random_user_info.state|escapejs}}')
      $('#zip').val('{{random_user_info.zip|escapejs}}')
      $('#occupation').val('{{random_user_info.occupation|escapejs}}')
      $('#employer').val('{{random_user_info.employer|escapejs}}')
      $('#ccNum').val('4111111111111111')
      $('#ccExp').val('1/2020')
      $('#ccCVV').val('000')
    }
  })

  function get_amount() {
    // Check that the number input looks numeric in its entirety. parseFloat
    // ignores non-parsable content at the end. English localization is
    // hard-coded in the regular expression and in the handling of commas.
    var amt = $('#amount').val();
    var re = RegExp($('#amount').attr('pattern'))
    if (!re.test(amt)) return null;

    // Strip thousands-commas, which parseFloat doesn't like.
    amt = amt.replace(/,/, '');

    // Attempt to parse. parseFloat returns NaN if the expression cannot
    // be parsed. To be sure we'll also check that it doesn't return +/-Inf
    // (all three conditions are handled by isFinite).
    amt = parseFloat(amt);
    if (!isFinite(amt)) return null;

    // Check that it has a whole number of cents.
    if (amt != Math.round(amt*100)/100) return null;

    // Check bounds.
    if (amt < {{min_contrib}} || amt > {{max_contrib}})
      return null;

    return amt;
  }

  function amount_validation() {
    var valid = true;
    if (get_amount() == null) {
      $('#amount-wrapper .input-group-addon').css({ color: '#666' })
      $('#amount').popover({ content: "Must be between {{min_contrib|currency}} and {{max_contrib|currency}}." }).popover('show');
      valid = false;
    } else {
      $('#amount-wrapper .input-group-addon').css({ color: 'green' })
      $('#amount').popover('destroy');
    }
    return valid;
  }

  function payment_validation() {
    // clear validation UI
    $('#ccNum').popover('destroy');
    $('#ccExp').popover('destroy');
    $('#ccCVV').popover('destroy');

    // validate card number
    if (!$.payment.validateCardNumber($('#ccNum').val())) {
      $('#ccNum').popover({ content: "Enter a credit card number." }).popover('show');
      return false;
    }

    // validate card expiration
    var exp = $('#ccExp').payment('cardExpiryVal');
    if (!$.payment.validateCardExpiry(exp.month, exp.year)) {
      $('#ccExp').popover({ content: "Enter a valid expiration date." }).popover('show');
      return false;
    }

    // overwrite field with normalized value -- the backend splits on the slash
    $('#ccExp').val(exp.month + "/" + exp.year);

    // validate card cvv
    if (!$.payment.validateCardCVC($('#ccCVV').val())) {
      $('#ccCVV').popover({ content: "Enter your card verification code, often found on the back side of the card." }).popover('show');
      return false;
    }

    return true;
  }

  function collect_form_data() {
    // Collect all of the form fields.
    var form_params = $('#contribution-form').serializeArray();
    var data = { };
    for (var i = 0; i < form_params.length; i++)
      data[form_params[i].name] = form_params[i].value;

    // Replace some fields with parsed values.
    data['amount'] = get_amount();

    // Add disabled recipients.
    data['disabled-recipients'] = [];
    $('#line-items .recipient-disabled').each(function() {
      var id = $(this).attr('data-recipient-id');
      data['disabled-recipients'].push(id);
    })
    data['disabled-recipients'] = data['disabled-recipients'].join(";");

    // Return.
    return data;    
  }

  function toggle_recipient(elem) {
    var row = $(elem).parent('tr');
    row.toggleClass("recipient-disabled");
    show_contribution_details_modal(true);
  }

  function show_contribution_details_modal(is_shown_already) {
    // Validation.
    if (!amount_validation())
      return null;

    // Submit.
    data = collect_form_data();
    ajax_with_indicator({
      // disable/enable controls while AJAX is happening
      controls: $('#contribution-form button'),

      // request
      url: '{{request.path|escapejs}}',
      method: "POST",
      data: data,

      // response
      success: function(res) {
        $('#line-items tr td.amount').text("nothing"); // clear so that line items that disappear are updated
        for (var i = 0; i < res.line_items.length; i++) {
          var line_item = res.line_items[i];
          var node = $('#line-items tr[data-recipient-id=' + line_item[0].id + "]");
          node.find("td.amount").text(line_item[1]);
        }
        if (!is_shown_already)
          $('#contribution_details_modal').modal();
      }
    })
  }

  function do_submit() {
    // Validation.
    if (!amount_validation())
      return null;
    if (!payment_validation())
      return null;

    // Prepare to submit.
    data = collect_form_data();
    data['method'] = 'execute';

    // Submit!
    ajax_with_indicator({
      // disable/enable controls while AJAX is happening
      controls: $('#contribution-form input, #contribution-form button'),

      // request
      url: '{{request.path|escapejs}}',
      method: "POST",
      data: data,

      // response
      keep_indicator_forever: true, /* on success we redirect */
      success: function(res) {
        // res.status == "error" is handled by ajax_with_indicator
        window.location = "/thank-you";
      }
    })

    // Instrumentation.

    // These might not execute if the AJAX request above is quick and
    // the reload begins before the mixpanel AJAX request is sent...

    // Mixpanel.
    //mixpanel.track("Pledge Submitted", { 'trigger': {{trigger.id}} });

  }


  </script>


{% endblock %}
